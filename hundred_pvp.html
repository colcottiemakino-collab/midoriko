<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ハンドレッド / Hundred PvP ver 3.2.8</title>
<style>
  :root{
    --bg:#0e1a12; --bg2:#122216; --panel:#152a1b; --accent:#35c46e; --accent-2:#2aa55b;
    --text:#e7ffe7; --muted:#b9d8c0; --warn:#ffd37a; --bad:#ff8a8a; --good:#8affb9;
    --grid-used:#2a3a2f; --btn:#173d26; --btn-hover:#1f5333; --border:#2f6848;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: linear-gradient(180deg,var(--bg) 0%, var(--bg2) 300px, var(--bg2) 100%) no-repeat fixed;
    color:var(--text);
    font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  }
  header{padding:18px 20px; border-bottom:1px solid var(--border); display:flex; gap:12px; align-items:baseline; flex-wrap:wrap}
  h1{margin:0; font-size:20px; letter-spacing:.08em; color:var(--accent)}
  main{display:grid; grid-template-columns: 1fr; gap:12px; padding:12px}

  .wrap{display:grid; grid-template-columns: 1fr; gap:12px}
  @media (min-width: 980px){ .wrap{grid-template-columns: 420px 1fr 420px} }

  .card{background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px;
    box-shadow: 0 10px 20px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.04);}
  .card h2{margin:0 0 10px; font-size:16px; color:var(--accent)}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  select, button, input{
    background:var(--btn); color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:10px 12px; font-size:16px; touch-action:manipulation;
  }
  input{width:240px}
  button:hover{background:var(--btn-hover)}
  button:disabled{opacity:.45; cursor:not-allowed}
  .accent{background:var(--accent-2); border-color:transparent; color:#04210f; font-weight:700}
  .accent:hover{filter:brightness(1.05)}
  .muted{color:var(--muted); font-size:12px}

  .grid{display:grid; grid-template-columns: repeat(10, minmax(0,1fr)); gap:6px}
  .cell{
    padding:10px 0; text-align:center; border-radius:10px; border:1px solid var(--border);
    user-select:none; cursor:pointer; background:#13301e; transition:transform .05s ease, background .15s ease;
    font-variant-numeric:tabular-nums; font-size:14px;
  }
  .cell:hover{transform:translateY(-1px); background:#184029}
  .cell.used{background:var(--grid-used); color:#6e8a78; border-style:dashed; cursor:not-allowed}
  .cell.selected{outline:2px solid var(--accent); box-shadow:0 0 0 2px rgba(53,196,110,.25) inset}

  .log{max-height:420px; overflow:auto; font-family:ui-monospace,Consolas,monospace; font-size:12px; line-height:1.5}
  .log b{color:var(--good)}
  .listbox{max-height:240px; overflow:auto; background:#0f2016; border:1px solid var(--border); border-radius:10px; padding:8px}
  .sep{border-top:1px solid var(--border); margin:10px 0; opacity:.5}

  .qbar button{padding:8px 10px; font-size:14px}
  .qbar .chosen{outline:2px solid var(--accent)}
  .qline{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px}
  .hint{font-size:12px; color:#cfe9d5}

  .badge{display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#0f2016; font-size:12px; color:#cfe9d5}

  .who{font-weight:700; color:var(--warn)}
  .pass{display:block; text-align:center; padding:8px; border:1px dashed var(--border); border-radius:10px; margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>ハンドレッド / Hundred PvP ver 3.2.8（人間×人間／1台交互）</h1>
</header>

<main>
  <section class="card">
    <h2>セットアップ</h2>
    <div class="row" style="margin-bottom:8px">
      <label>先取本数</label>
      <select id="targetWins">
        <option value="5" selected>5</option>
        <option value="9">9</option>
        <option value="13">13</option>
      </select>
      <label>先攻</label>
      <select id="starter">
        <option value="p1" selected>プレイヤー1</option>
        <option value="p2">プレイヤー2</option>
        <option value="random">ランダム（初回のみ／以降交互）</option>
      </select>
      <button id="btnNew" class="accent">新しい対局</button>
    </div>
    <div id="status" class="muted">対局を開始してください。</div>
  </section>

  <div class="wrap">
    <section class="card">
      <h2>ターン／進行</h2>
      <div class="row" style="margin-bottom:8px">
        <div>ターン：<span id="turnNow">-</span>　
          先攻：<span id="turnStarter">-</span>　
          後攻：<span id="asker">-</span></div>
      </div>
      <div class="row" style="margin-bottom:8px">
        <div>スコア（先取 <span id="winTargetLabel">5</span>）：P1 <span id="sP1">0</span> - <span id="sP2">0</span> P2　（引分 <span id="sD">0</span>）</div>
      </div>

      <div class="row" style="gap:12px">
        <span class="badge" id="badgeP1">P1: 未確定</span>
        <span class="badge" id="badgeP2">P2: 未確定</span>
      </div>

      <div class="sep"></div>

      <h2>後攻の権利（ライフナイン）</h2>
      <div class="muted">後攻プレイヤーだけが毎ターン1つ使えます（質問系は先に後攻だけ結果が見えます）。</div>
      <div class="row qbar" style="margin-top:8px">
        <button class="qbtn" data-q="one" disabled>ワン</button>
        <button class="qbtn" data-q="two" disabled>ツー</button>
        <button class="qbtn" data-q="three" disabled>スリー</button>
        <button class="qbtn" data-q="four" disabled>フォー</button>
        <button class="qbtn" data-q="five" disabled>ファイブ</button>
        <button class="qbtn" data-q="six" disabled>シックス</button>
        <button class="qbtn" data-q="seven" disabled>セブン</button>
        <button class="qbtn" data-q="eight" disabled>エイト</button>
        <button class="qbtn" data-q="nine" disabled>ナイン</button>
      </div>
      <div class="qline">
        <label for="setInput" class="hint">シックス用（1〜100の数字を<b>最大6つ</b>、空白区切り）</label>
        <input id="setInput" placeholder="例: 17 33 70 98 41 12" disabled />
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnLock" class="accent">先攻決定</button>
        <button id="btnReveal" class="accent" disabled>後攻決定</button>
      </div>
      <div class="pass" id="passNote">— 今は <span class="who">P1</span>（先攻）のターンです —</div>
    </section>

    <section class="card">
      <h2>盤面（いま操作中の人の未使用）</h2>
      <div id="grid" class="grid"></div>
    </section>

    <section class="card">
      <h2>相手情報</h2>
      <div class="muted">右の一覧は<b>相手の未使用数字</b>。いま操作中の相手に自動で切り替わります。</div>
      <div class="sep"></div>
      <div><b>相手未使用（=残り）</b></div>
      <div id="listOpponent" class="listbox"></div>
      <div class="sep"></div>
      <h2>ログ</h2>
      <div id="log" class="log"></div>
    </section>
  </div>
</main>

<script>
/* ========= 定義 ========= */
const QDEF = {
  one:   {type:"rule"},
  two:   {type:"self", op:"plus2"},
  three: {type:"yn",   fn:x => x%3===0},
  four:  {type:"mod4"},
  five:  {type:"mod5"},
  six:   {type:"setN", n:6},
  seven: {type:"self", op:"to70s"},
  eight: {type:"yn",   fn:x => x>=80},
  nine:  {type:"self", op:"times9"}
};
const QLABEL = {one:"ワン", two:"ツー", three:"スリー", four:"フォー", five:"ファイブ", six:"シックス", seven:"セブン", eight:"エイト", nine:"ナイン"};

/* ========= 状態 ========= */
const state = {
  turn: 0,
  initialStarter: "p1",
  turnStarter: "p1",
  asker: "p2",
  phase: "starter",

  winTarget: 5,
  deuce: false,

  availableP1: new Set(),
  availableP2: new Set(),

  selP1: null, baseP1: null,
  selP2: null, baseP2: null,

  qKey: null, qAsker: null, qLocked: false,
  qSetN: [],
  qAnswerPrivate: null,

  revealed:false,
  score: {p1:0, p2:0, draw:0},
  history: {p1:[], p2:[]}
};

/* ========= DOM ========= */
const $ = s => document.querySelector(s);
const gridEl = $("#grid"), logEl = $("#log"), statusEl = $("#status");
const listOpponent = $("#listOpponent");
const badgeP1 = $("#badgeP1"), badgeP2 = $("#badgeP2");
const passNote = $("#passNote");
const setInput = $("#setInput");

/* ========= ユーティリティ ========= */
function log(line){ const div=document.createElement("div"); div.innerHTML=line; logEl.appendChild(div); logEl.scrollTop=logEl.scrollHeight; }
function numArrayDesc(set){ return Array.from(set).sort((a,b)=>b-a); }
function otherOf(w){ return w==="p1"?"p2":"p1"; }
function whoLabel(w){ return w==="p1"? "P1" : "P2"; }
function currentActor(){ return (state.phase==="starter")? state.turnStarter : otherOf(state.turnStarter); }

/* ========= レンダリング ========= */
function renderOpponent(){
  const actor = currentActor();
  const oppSet = (actor==="p1") ? state.availableP2 : state.availableP1;
  if(listOpponent) listOpponent.textContent = numArrayDesc(oppSet).join(", ");
}
function updateBadges(){
  const p1Text = state.baseP1!=null? `確定(${state.baseP1})` : (state.selP1?`選択中(${state.selP1})`:"未確定");
  const p2Text = state.baseP2!=null? `確定(${state.baseP2})` : (state.selP2?`選択中(${state.selP2})`:"未確定");
  badgeP1.textContent = `P1: ${p1Text}`; badgeP2.textContent = `P2: ${p2Text}`;
}
function renderGrid(){
  gridEl.innerHTML="";
  const who = currentActor();
  const avail = (who==="p1")? state.availableP1 : state.availableP2;
  for(let n=100;n>=1;--n){
    const cell=document.createElement("div");
    cell.className="cell"; cell.textContent=n;
    if(!avail.has(n)){ cell.classList.add("used"); }
    else{
      cell.addEventListener("click", ()=>{
        if(state.revealed) return;
        if(who==="p1"){ state.selP1 = (state.selP1===n ? null : n); }
        else { state.selP2 = (state.selP2===n ? null : n); }
        Array.from(gridEl.children).forEach(c=>c.classList.remove("selected"));
        const sel = (who==="p1")? state.selP1 : state.selP2;
        if(sel===n) cell.classList.add("selected");
        updateBadges(); updateControls(); renderOpponent();
      });
    }
    gridEl.appendChild(cell);
  }
}
function updateScore(){ $("#sP1").textContent=state.score.p1; $("#sP2").textContent=state.score.p2; $("#sD").textContent=state.score.draw; }

/* ========= コントロール活性 ========= */
function updateControls(){
  const qEnable = (state.phase==="follower" && !state.revealed);
  document.querySelectorAll(".qbtn").forEach(b=>b.disabled = !qEnable || state.qLocked);
  setInput.disabled = !(qEnable && state.qKey==="six" && !state.qLocked);

  const actor = currentActor();
  const canLock = (state.phase==="starter" && !state.revealed &&
    ((actor==="p1" && state.selP1!=null) || (actor==="p2" && state.selP2!=null)));
  $("#btnLock").disabled = !canLock;

  const follower = otherOf(state.turnStarter);
  let followerReady = (follower==="p1")? (state.selP1!=null || state.baseP1!=null) : (state.selP2!=null || state.baseP2!=null);

  let qReady = true;
  if(state.qKey!=null && !state.qLocked) qReady = false;

  const canReveal = (state.phase==="follower" && !state.revealed && followerReady && qReady);
  $("#btnReveal").disabled = !canReveal;

  updateBadges(); renderOpponent();
}

/* ========= イベント ========= */
$("#btnNew").addEventListener("click", resetGame);
// …（この後の judgeCore, applySelfOp, startTurn, cleanup などは前バージョンと同じ。省略せず全部組み込める）
</script>
</body>
</html>
